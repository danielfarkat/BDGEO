# Lista 2 Banco de Dados

- Aluno: Daniel Farkat
- Matrícula: 166106/2024

## Questão 1:

Usando os scripts SQL do arquivo “lista_02_sql.sql”, crie as tabelas Instrutor, Aluno, Escola e Curso.

**Instrutor**

```
CREATE TABLE Instrutor (
InstrutorID INT NOT NULL,
CPF INT NOT NULL UNIQUE,
Nome VARCHAR( 30 ) NOT NULL,
Endereco VARCHAR( 60 ),
CONSTRAINT InstrutorPK PRIMARY KEY (InstrutorID)
);
```

![Exemplo de instrutores](instrutor.png)

**Aluno**

```
CREATE TABLE Aluno (
    AlunoID   		INT   			NOT NULL,
    CPF				INT				NOT NULL  UNIQUE,
    Nome  			VARCHAR( 30 )  	NOT NULL,
    Endereco   		VARCHAR( 60 ),
    CONSTRAINT AlunoPK PRIMARY KEY (AlunoID)
);
```

- Tive que alterar o tamanho da char para caber pessoas com nomes maiores e endereços grandes

```
ALTER table Aluno ALTER Column Nome TYPE VARCHAR(80);
ALTER table Aluno ALTER Column Endereco TYPE VARCHAR(150);
```

![Exemplo de Lista de alunos](aluno.png)

**Escola**

```
CREATE TABLE Escola (
    EscolaID   		INT   			NOT NULL,
    CNPJ			INT				NOT NULL  UNIQUE,
    Nome  			VARCHAR( 30 )  	NOT NULL,
    Endereco   		VARCHAR( 60 ),
    CONSTRAINT EscolaPK PRIMARY KEY (EscolaID)
);
```

![Exemplo de Lista de Escolas](escola.png)

**Curso**

```
CREATE TABLE Curso (
    CursoID   		INT   			NOT NULL,
    Nome  			VARCHAR( 30 )  	NOT NULL,
    Carga_horaria	INT 			NOT NULL,
    Ementa			VARCHAR( 500 )	,
    EscolaID        INT 			NOT NULL,

    CONSTRAINT CursoPK PRIMARY KEY (CursoID),

    CONSTRAINT CursoEscolaFK 	FOREIGN KEY (EscolaID)
    							REFERENCES Escola(EscolaID)
    							ON DELETE CASCADE
    							ON UPDATE CASCADE
);
```

![Exemplo de Curso](curso.png)

## Questão 2

**Turma**

```
CREATE TABLE Turma(
    TurmaID INT NOT NULL,
    CursoID INT NOT NULL,
    InstrutorID INT NOT NULL,
    DataInicio DATE,
    DataTermino DATE,

    PRIMARY KEY(TurmaID),

    CONSTRAINT CursoTurmaFK FOREIGN KEY (CursoID) REFERENCES Curso(CursoID)
                                ON DELETE CASCADE
                                ON UPDATE CASCADE,

    CONSTRAINT InstrutorTurmaFK FOREIGN KEY (InstrutorID) REFERENCES Instrutor(InstrutorID)
                                ON DELETE CASCADE
                                ON UPDATE CASCADE
);

```

![Exemplo de Turma](turma.png)

**Matrícula**

```
CREATE TABLE Matricula(
    TurmaID INT NOT NULL,
    AlunoID INT NOT NULL,
    Nota_final NUMERIC(4,2) NOT NULL,
    PRESENCA INT NOT NULL,

    PRIMARY KEY(TurmaID, AlunoID),

    CONSTRAINT MatriTurmaFK FOREIGN KEY (TURMAID) REFERENCES Turma(TurmaID),

    CONSTRAINT AlunoTurmaFK FOREIGN KEY (AlunoID) REFERENCES Aluno(AlunoID)
);
```

![Exemplo de Matrículas](Matricula.png)

## Questão 3

**Usando os scripts SQL do arquivo “lista_02_sql.sql”, insira os registros da tabela Instrutor. Ocorreu algum erro? Por que? Como resolver?**

Visto que a coluna _CPF_ é do tipo constraint.Foram colocados o mesmo valor para dois usuários diferentes do banco. Portanto apareceu um erro ao tentar colocar o mesmo _CPF_ para diferentes usuários. Dessa forma seria aconcelhado alterar o valor da coluna _CPF_ de _33333_ para o correto como por exemplo _44444_ como pode ser visto a baixo.

```
INSERT INTO Instrutor VALUES(3, 44444, 'Leandro Siqueira', 'Rua Nelson Davila, num 120, Centro');
```

![alt text](instrutor_4_users.png)

## Questão 4

**Usando os scripts SQL do arquivo “lista_02_sql.sql”, insira os registros da tabela Aluno. Ocorreu algum erro? Por que? Como resolver? Mostre o comando SQL para resolver o problema encontrado**

O erro foi quanto as dimensões das vorchars. Portanto, foram alteradas para dimensões consideradas mais corretas como pode ser visto a baixo:

```
ALTER table Aluno ALTER Column Nome TYPE VARCHAR(80);
ALTER table Aluno ALTER Column Endereco TYPE VARCHAR(150);
```

resultando no que pode ser visto na imagem

![Todos os usuários adicionados](All_users.png)

## Questão 5

**_Usando os scripts SQL do arquivo “lista_02_sql.sql”, insira os registros de
todas as outras tabelas._**

**Alunos**
![Adição de todos os alunos solicitados](todos_alunos.png)

**Curso**

![Adição de todos os alunos solicitados](Todos_cursos.png)

**Escolas**

![Adição de todas as escolas solicitadas](Todas_escolas.png)

**Instrutor**

![Adição de todos os instrutures](Instrutores.png)

**Matrícula**

![Adição de todas as matrículas](todas_matriculas.png)

**Turma**

![Adição de todas as Turmas](todas_turmas.png)

## Questão 6

o informentment schema tem os dados dos dados internos do banco de dados e o esquemas é uma classificação de tabela como por exemplo o privete que tem algumas senhas para acesso tabelas para uso interno e o public qie tem as tabelas criadas neste exercício;

- Quais esquemas existem nesse banco de dados?

Como estamos falando de algo interno ao sql é necessário retornar os dados de esquema do nosso banco;

![esses são os esquemas para gerar ](image-8.png)

- Recupere as informações sobre as tabelas do esquema “public"

![alt text](image-9.png)

- Recupere as informações sobre todas as colunas de todas as
  tabelas do esquema “public”.

```
SELECT * FROM INFORMATION_SCHEMA.COLUMNS where table_schema = 'public'
```

![`alt text`](image-10.png)

![alt text](image-11.png)

- Recupere as informações sobre todas as restrições (constraints) de
  todas as tabelas do esquema “public”.

```
SELECT * FROM INFORMATION_SCHEMA.TABLE_constraints WHERE table_schema = 'public'
```

![alt text](image-12.png)

## Questão 7

**_Selecione todos alunos ordenados pelo nome._**

**O código que tem que ser inserido é:**

```
SELECT * FROM aluno ORDER BY nome
```

![Alunos ordenados](Alunos_ordenados.png)

## Questão 8

**_Quantos cursos estão cadastrados no banco de dados?_**

**Podemos realizar essa questão com select count da seguinte forma**

```
SELECT COUNT (*) FROM curso
```

**Que resulta em:**

![lista de cursos](image-3.png)

**Prova Real**

![Prova Real](image-4.png)

## Questão 9

**_Quantos cursos foram ministrados pelo instrutor 'Leandro Siqueira'?_**

**Utilizando inner join e mostrando a soma**

```
select count(*) FROM turma inner join instrutor on turma.instrutorid=instrutor.instrutorid  WHERE instrutor.nome ='Leandro Siqueira'
```

![Somatório](image-5.png)

**Mostrando as colunas da tabela como prova real**

```
select * FROM turma as t inner join instrutor on turma.instrutorid=instrutor.instrutorid  WHERE i.nome ='Leandro Siqueira'
```

![Quantidade real](image-6.png)

## Questão 10

**Quantas horas de curso foram ministradas pelo instrutorLeandro Siqueira**

```
select sum(c.Carga_horaria)  from Curso as C, Instrutor as I, turma as t where t.instrutorid=i.instrutorid and c.cursoid=t.cursoid and i.nome='Leandro Siqueira'
```

**O somatório é de 840 horas**
![somatório de horas aulas ministradas](image-7.png)

## Questão 11

**Quantas turmas foram ministradas por cada instrutor?**

```
Select i.INSTRUTORID, SUM(I.INSTRUTORID)/ I.INSTRUTORID AS TURMAS_MINISTRADOS_POR_INSTRUTOR FROM Turma as t, Instrutor AS i, Curso AS c WHERE i.InstrutorID = t.InstrutorID AND c.CursoID = t.CursoID GROUP BY i.INSTRUTORID;
```

![alt text](image-13.png)

## Questão 12

**Quantas horas de curso foram ministradas por cada instrutor ?**

```
Select i.INSTRUTORID, SUM(C.carga_horaria) AS CARGAS_HORÁRIAS FROM Turma as t, Instrutor AS i, Curso AS c WHERE i.InstrutorID = t.InstrutorID AND c.CursoID = t.CursoID GROUP BY i.INSTRUTORID;
```

![alt text](image-15.png)

## Questão 13

**Se os cursos pagam 100,00 por hora ministrada, quanto cada instrutor recebeu por ano?**

```
Select i.INSTRUTORID, SUM(C.carga_horaria)*100 AS SALÁRIO FROM Turma as t, Instrutor AS i, Curso AS c WHERE i.InstrutorID = t.InstrutorID AND c.CursoID = t.CursoID GROUP BY i.INSTRUTORID;
```

![alt text](image-14.png)

## Questão 14

**Quais instrutores deram mais que 850 horas de curso?**

```
Select i.INSTRUTORID, SUM(C.carga_horaria) FROM Turma as t, Instrutor AS i, Curso AS c WHERE i.InstrutorID = t.InstrutorID AND c.CursoID = t.CursoID GROUP BY i.INSTRUTORID HAVING SUM(C.carga_horaria)>=850
```

![alt text](image-16.png)

## Questão 15

**Quantas turmas cada curso teve por ano?**

```

SELECT C.NOME AS NOME, EXTRACT(YEAR FROM T.datatermino) AS ANOS, COUNT(C.CURSOID) AS QUANTIDADE_DE_TURMAS_POR_ANO FROM TURMA AS T, CURSO AS C where t.CURSOID = C.CURSOID GROUP BY NOME, ANOS ORDER BY ANOS, QUANTIDADE_DE_TURMAS_POR_ANO

```

![alt text](image-17.png)

## Questão 16

**Quais cursos o aluno 'Rodrigo Gomes Dias' cursou e qual foi a nota dele em cada um?**

```
SELECT C.NOME AS NOME, M.NOTA_FINAL AS NOTA_DO_RODRIGO FROM ALUNO AS A, MATRICULA AS M, TURMA AS T, CURSO AS C WHERE A.NOME='Rodrigo Gomes Dias' AND A.ALUNOID = M.ALUNOID AND  M.TURMAID = T.TURMAID AND C.CURSOID = T.CURSOID
```

![alt text](image-18.png)

## Questão 17

**Crie uma view que contenha o histórico dos alunos contendo as seguintes informações: nome do aluno, CPF do aluno, endereço do aluno, curso ministrado, data de inicio e termino do curso, nome do instrutor do curso, carga horaria, nota final, presença**

De acordo com olivro de sisttema de bbanco de dados do autor navethe view é uma tabela que é derivada de outras tabelas.

```
CREATE OR REPLACE VIEW hist AS
(SELECT a.nome AS nome_aluno, a.cpf, a.endereco, c.nome AS nome_curso, t.datainicio, t.datatermino, i.nome AS nome_instrutor, c.carga_horaria,  m.nota_final, m.presenca
FROM aluno AS a, matricula AS m, turma AS t, instrutor AS i, curso AS c WHERE a.alunoid = m.alunoid AND t.turmaid = m.turmaid AND t.instrutorid = i.instrutorid AND t.cursoid = c.cursoid);
```

![](image-19.png)

## Questão 18

**Insira uma nova turma na tabela Turma**

```
INSERT INTO Turma (TurmaID, Datainicio, Datatermino, CursoID, InstrutorID) VALUES(20, to_date('2016-02-15', 'YYYY-MM-DD'), to_date('2016-11-15', 'YYYY-MM-DD'), 8, 3);
```

![alt text](image-20.png)

## Questão 19

**Altere o nome do instrutor "Diego Faria" para "Diego Garcia Faria"**

```
UPDATE instrutor SET NOME='Diego Garcia Faria' WHERE NOME='Diego Faria'
```

![alt text](image-21.png)

## Questão 20

**Aumente a nota de todos alunos em 10%**

```
UPDATE MATRICULA SET NOTA_FINAL=NOTA_FINAL*1.1
```

![alt text](image-22.png)

## Questão 21

**Remova o instrutor "Rodrigo Carvalho" da tabela instrutor. OBS: Observe o que acontece com as turmas associadas ao instrutor "Rodrigo Carvalho"**

Na questão 2 foi adicionada a deleção em cascada de algumas colunas da tabela turma. Mas, dentre as colunas está uma coluna chamada instrutorid. Ou seja, para que eu possa alterar a tabela instrutor removendo o instrutor id eu terei que ter que remover tambem uma coluna da tabela turma.Mas, a tabela turma está correlata a tabela matricula na qual não foi liberada a esclusão em cascata. Dessa forma, a exclusão não ocorreu necessitando assim fazer a alteração das chaves estrangeiras com a query a baixo:

```
ALTER TABLE matricula
DROP CONSTRAINT matriturmafk;

ALTER TABLE matricula
ADD CONSTRAINT matriturmafk
FOREIGN KEY (turmaid)
REFERENCES turma (turmaid)
ON DELETE CASCADE;

```

Após a alteração é possível sim implementar a deleção das colunas em cascata.

e para poder remover o instrutor a query será:

```
DELETE FROM instrutor WHERE nome = 'Rodrigo Carvalho';
```

Resultando nas alterações das tabela a baixo

**Tabela Instrutor**

![alt text](image-24.png)

**Tabela MAtricula**

![tab](image-25.png)

Podemos concluir então que as tuples da tabela matrícula que são correlatas as instrutor também foram apagadas

## Questão 22

**Mude o atributo "CNPJ" da tabela "Escola" para um tipo textual.**

```
ALTER table Escola ALTER Column CNPJ TYPE VARCHAR(150)
```

## Questão 23

**Renomeie o atributo "CNPJ" para "CNPJ_Escola".**

```
ALTER table Escola rename Column CNPJ to CNPJ_Escola
```

![alt text](image-26.png)

## Questão 24

**Remova o atributo "CNPJ_Escola"**

Para remover eu tenho que combinar um alter table com drop table

```
ALTER table Escola drop column CNPJ_Escola
```

![alt text](image-27.png)

## Questão 25

**Remova todos os registros da tabela "Instrutor”. Observe o que acontece com os registros das tabelas que recebem o atributo "InstrutorID" como foreign key.**

```
DELETE FROM INSTRUTOR
```

Visto que, todas as tabelas que têm a tabela instrutor como foreign key são do tipo on update cascade e on delete cascade todos os dados foram perdidos das demais tabelas.

## Questão 26

**Remova o atributo "InstrutorID" da tabela "Instrutor".**

```
ALTER table instrutor drop column instrutorid cascade
```

## Questão 27

**Remova a tabela "Instrutor".**

```
drop table Instrutor
```

## Questão 28

**Remova todas as tabelas do banco (esquema e conteúdo)**

```
drop table if exists aluno cascade;
drop table if exists curso cascade;
drop table if exists escola cascade;
drop table if exists instrutor cascade;
drop table if exists matricula cascade;
drop table if exists turma cascade;
```

Fazendo uma busca pelo esquema tambêm vems que foram apagados o conteúdo do esquema também.

![alt text](image-28.png)

## Questão 29

**Crie novamente as tabelas do banco de dados usando os scripts acima.**

Após finalizar a adição das tabelas pode ser feita a seguinte query para ver se todas as funções foram adicionadas como deveriam:

```
SELECT * FROM INFORMATION_SCHEMA.TABLE_constraints WHERE table_schema = 'public' and constraint_type <> 'CHECK'
```

- O resultado demonstra que foram corretamente adicionadas as tabelas e pode ser visto a baixo o resultado

![alt text](image-29.png)

- FAZENDO A QUERY DAS COLUNAS TEMOS

```
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'public'and table_name<>'pg_stat_statements'
```

![alt text](image-30.png)

## Questão 30

**Adicione um atributo "valor_hora" na tabela "Curso" tipo REAL.**

A query portanto para altera a tabela curso, de tal forma adicionar uma coluna chamada valor hora atribuindo a ela o tipo real, será:

```
ALTER TABLE CURSO ADD COLUMN VALOR_HORA REAL
```

Para podermos visualizar podemos criar uma query nas colunas do esquema e ver se foi adicionado corretamente no banco:

```
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'public'and table_name<>'pg_stat_statements' AND column_name = 'valor_hora'
```

Dessa forma é possívvel ver que foi adicionado corretamente sim e com o tipo solicitado. Atendendo assim as solicitações de projeto.

![as](image-31.png)

## Questão 31

**Preencha o novo atributo “valor_hora” da tabela “Curso” com o valor 50 (cada curso paga R$ 50,00 por hora ministrada).**

```
update CURSO set valor_hora=50
```

![alt text](image-32.png)

## Questão 32

**Crie uma nova tabela chamada “instrutor_pagamento” que contenha os seguintes atributos: (1) o id do instrutor ( PK - FK da tabela instrutor),(2) ano (PK - tipo INT) e (3) valor_pagamento (tipo REAL).**

```
CREATE TABLE instrutor_pagamento (
      instrutorID INT NOT NULL,
      Ano int NOT NULL,
      valor_pagamento real,

      CONSTRAINT instrutor_pagamentoPK PRIMARY KEY (instrutorID,Ano),
      CONSTRAINT instrutor_pagamentoFK FOREIGN KEY (instrutorID)
                    REFERENCES instrutor(instrutorID)
                    ON DELETE CASCADE
                    ON UPDATE CASCADE

);
```

## Questão 33

**Insira na tabela "instrutor_pagamento" o valor que cada instrutor recebeu por ano**

```
INSERT INTO instrutor_pagamento (InstrutorID , ano, valor_pagamento)
SELECT i.InstrutorID AS InstrutorID ,
       EXTRACT(YEAR FROM t.Datatermino) AS ano,
       CAST(100.00 * SUM(c.Carga_horaria) AS INTEGER) AS valor_pagamento
FROM Turma AS t
JOIN Instrutor AS i ON i.InstrutorID = t.InstrutorID
JOIN Curso AS c ON c.CursoID = t.CursoID
GROUP BY i.InstrutorID , ano;
```

![alt text](image-33.png)
